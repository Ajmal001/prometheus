window.Prometheus=function(){function e(){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","http://vingkan.github.io/prometheus/script/html2canvas.min.js"),document.getElementsByTagName("head")[0].appendChild(e)}function t(e){var t=firebase.database().ref("prometheus"+e);return t}function n(e){var t={location:{},country:{}},n=new XMLHttpRequest;n.open("GET","https://geoip.nekudo.com/api/",!1);try{n.send();var i=n.responseText;t=JSON.parse(i)}catch(r){}e&&e(t)}function i(e){d.latitude=e.location.latitude,d.longitude=e.location.longitude,d.city=e.city,d.country=e.country.name,d.ip=e.ip,d.isValid=null!=d.latitude}function r(){var e="NO_GEOLOCATION_EXCEPTION";return d.isValid&&(e={latitude:d.latitude,longitude:d.longitude,city:d.city,country:d.country,ip:d.ip}),e}function o(){return{timestamp:Date.now(),timezoneOffset:(new Date).getTimezoneOffset()}}function a(){var e,t=navigator.userAgent,n=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(e=/\brv[ :]+(\d+)/g.exec(t)||[],{name:"IE",version:e[1]||""}):"Chrome"===n[1]&&(e=t.match(/\bOPR\/(\d+)/),null!=e)?{name:"Opera",version:e[1]}:(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/(\d+)/i))&&n.splice(1,1,e[1]),{name:n[0],version:n[1]})}function s(){return{url:location.href}}function c(e){var t;switch(e){case"location":t=r();break;case"datetime":t=o();break;case"browser":t=a();break;case"page":t=s();break;case"all":t={location:r(),datetime:o(),browser:a(),page:s()};break;default:t="BAD_REQUEST_EXCEPTION"}return t}function u(e){"Notification"in window?"granted"===Notification.permission?l(e):"denied"!==Notification.permission?Notification.requestPermission(function(t){"granted"===t&&l(e)}):console.warn("Notification permissions rejected."):console.warn("Notifications not supported.")}function l(e){if(e.message){e.icon||(e.icon="http://vingkan.github.io/prometheus/img/contrast-logo.png");var t=new Notification(e.message,e);e.clickFn&&(t.onclick=function(t){t.preventDefault(),e.clickFn()})}else var t=new Notification(e)}var f,v,p=function(r){firebase.initializeApp(r),v=!0,v&&n(i),r.noScreenshots&&r.noScreenshots===!0?f=!1:(f=!0,e());var o={trackUser:function(e){e&&sessionStorage.setItem("prometheus_user",e)},getUID:function(){var e="ANONYMOUS_USER";return this.isTrackingUser()&&(e=sessionStorage.getItem("prometheus_user")),e},save:function(e,n){var i=this.getUID(),r=e||{type:"SAVED_VISIT"},o=n||"all",a=t("/users/"+i+"/visits");a.push({meta:this.get(o),visit:r})},error:function(e){var t={type:"ERROR",message:e.message,url:e.url,line:e.line};this.capture(t)},logon:function(e,n,i){if(e){if(this.trackUser(e),n){var r=t("/users/"+e+"/profile");r.set(n)}this.save({type:"USER_LOGON"},i)}},capture:function(e){var e=e||{};e.type||(e.type="SCREEN_CAPTURE");var t=this;f?html2canvas(window.parent.document.body,{onrendered:function(n){n.style.display="none",document.body.appendChild(n);var i=n.toDataURL("image/png");e.img=i,t.save(e)}}):(e.img_note="NONE_TAKEN",this.save(e))},isTrackingUser:function(){var e=!1,t=sessionStorage.getItem("prometheus_user");return t&&(e=!0),e},get:function(e){var t={};if(Array.isArray(e)&&e.length>0)if(e.includes("all"))t=c("all");else for(var n=0;n<e.length;n++){var i=e[n];t[i]=c(i)}else t=e?c(e):"BAD_REQUEST_EXCEPTION";return t},deliver:function(e,n,i){var r=this.getUID(),o=t("/features/"+e+"/access/");o.once("value",function(e){var t=e.val(),o=!1;for(var a in t)if(r===t[a]){n(),o=!0;break}!o&&i&&i()})},Note:function(e){var n=this;return{seen:function(t){var i=t||{};i.type="NOTIFICATION_CLICKED",i.noteid=e,n.save(i)},terminate:function(i){var r=n.getUID(),o=t("/features/"+e+"/access/");o.once("value",function(o){var a=o.val();for(var s in a)if(a[s]===r){var c=t("/features/"+e+"/access/"+s);c.remove();var u=i||{};u.type="NOTIFICATION_TERMINATED",u.noteid=e,n.save(u);break}})}}},notify:function(e,t,n){var i=this;this.deliver(e,function(){u({message:t.title||"Alert",body:t.message||"",icon:t.icon||r.icon||null,clickFn:function(){var t=i.Note(e);n?n(t):t.seen()}})})},toString:function(){return console.log(r),"Bringing Firebase to humanity!"}};return window.onerror=function(e,t,n){console.warn("Error recorded by Prometheus.js."),o.error({message:e,url:t,line:n})},o},d={latitude:0,longitude:0,isValid:!1};return p}();